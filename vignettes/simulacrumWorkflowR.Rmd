---
title: "Example: Running the whole workflow"
author: "Jakob Skelmose, Rasmus Rask, Lars Nielsen, Charles Vesteghem, Jennifer Bartell, Martin BÃ¸gsted"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example Running the whole workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(simulacrumWorkflowR)
library(survival)
library(openxlsx)
library(broom)
library(openxlsx)
```


```{r}
dir <- "C:/Users/p90j/Documents/simulacrum_v2.1.0/Data"
data_frames_lists <- read_simulacrum(dir, selected_files = c("sim_av_patient", "sim_av_tumour")) 
```


#dfs
```{r}
SIM_AV_PATIENT <- data_frames_lists$sim_av_patient
SIM_AV_TUMOUR <- data_frames_lists$sim_av_tumour
```

# demonstration of the sql query translator 
```{r}
query2 <- "select *
from SIM_AV_PATIENT
limit 500;"
```

```{r}
print(sqlite2oracle(query2))
```

# Run query on SQLite database
#### Select the variables of interest
```{r}
df1 <- query_sql("SELECT 
SIM_AV_PATIENT.PATIENTID, SIM_AV_PATIENT.GENDER, SIM_AV_PATIENT.VITALSTATUS, SIM_AV_PATIENT.VITALSTATUSDATE, SIM_AV_TUMOUR.DIAGNOSISDATEBEST, SIM_AV_TUMOUR.AGE, SIM_AV_TUMOUR.PERFORMANCESTATUS, SIM_AV_TUMOUR.SITE_ICD10_O2_3CHAR

FROM SIM_AV_PATIENT
INNER JOIN SIM_AV_TUMOUR 
    ON SIM_AV_PATIENT.patientid = SIM_AV_TUMOUR.patientid;
")
```

# Additional preprocessing
```{r}

df_surv <- survival_days(df1)
df_surv$VITALSTATUS <- ifelse(df_surv$VITALSTATUS == "A", 1,
                              ifelse(df_surv$VITALSTATUS == "D", 0, NA))

df_complete <- cancer_grouping(df_surv)
extended_summary(df_complete)
```


# example of a Cox model of the synthetic data
```{r}
cox_model <- coxph(Surv(diff_date, VITALSTATUS) ~ AGE + factor(GENDER) + factor(PERFORMANCESTATUS), data=df_complete)
summary(cox_model)
```

# Example of a Logistic regression of the synthetic data
```{r}
log_model <- glm(VITALSTATUS ~ AGE + factor(GENDER) + factor(PERFORMANCESTATUS), data=df_complete, family = "binomial")
summary(log_model)
```
# Save models as html tabels


```{r}
stop <- stop_time()
#compute_time_limit(start, stop)
```